<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Amazon CSV Sync — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">Amazon CSV Sync (Visiotech)</h1>

  <!-- Stats -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Estado</h5>
      <div id="stats">
        <p><strong>Produtos processados:</strong> {{ stats.produtos_processados }}</p>
        <p><strong>Marketplace:</strong> {{ stats.marketplace_ativo }}</p>
        <p><strong>Última sincronização:</strong> {{ stats.ultima_sincronizacao }}</p>
      </div>
    </div>
  </div>

  <!-- Upload CSV -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Upload CSV do Fornecedor</h5>
      <form id="csvForm" class="mt-3">
        <input type="file" class="form-control" name="csv_file" id="csv_file" accept=".csv" required />
        <button type="submit" class="btn btn-primary mt-3">Processar CSV</button>
      </form>
      <div id="uploadResult" class="mt-3"></div>
    </div>
  </div>

  <!-- Ações -->
  <div class="d-flex gap-2">
    <a class="btn btn-secondary" href="/review_data">Rever dados processados</a>
    <button id="syncBtn" class="btn btn-success" onclick="syncAmazon()">Sincronizar com Amazon (simulação)</button>
  </div>
</div>

<script>
document.getElementById('csvForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = new FormData();
  const file = document.getElementById('csv_file').files[0];
  if (!file) return;
  form.set('csv_file', file);

  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true; btn.textContent = 'A processar...';

  try {
    const res = await fetch('/upload_csv', { method: 'POST', body: form });
    const data = await res.json();
    if (data.success) {
      document.getElementById('uploadResult').innerHTML = `
        <div class="alert alert-success">
          <strong>OK!</strong> ${data.message}<br>
          Produtos: <strong>${data.stats.total_produtos}</strong><br>
          Preço médio: <strong>€${(data.stats.preco_medio||0).toFixed(2)}</strong><br>
          Com stock: <strong>${data.stats.produtos_com_stock}</strong>
        </div>`;
    } else {
      document.getElementById('uploadResult').innerHTML =
        '<div class="alert alert-danger"><strong>Erro:</strong> ' + (data.error || 'Falha no upload') + '</div>';
    }
  } catch (err) {
    document.getElementById('uploadResult').innerHTML =
      '<div class="alert alert-danger"><strong>Erro de rede:</strong> ' + err.message + '</div>';
  } finally {
    btn.disabled = false; btn.textContent = 'Processar CSV';
  }
});

async function syncAmazon() {
  const btn = document.getElementById('syncBtn');
  btn.disabled = true; btn.textContent = 'A sincronizar...';
  try {
    const res = await fetch('/sync_amazon', { method: 'POST', headers: {'Content-Type':'application/json'} });
    const data = await res.json();
    if (data.success) {
      alert('Sincronização concluída: ' + (data.message || 'OK'));
      location.reload();
    } else {
      alert('Erro na sincronização: ' + (data.error || 'Desconhecido'));
    }
  } catch (e) {
    alert('Erro de rede: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Sincronizar com Amazon (simulação)';
  }
}
</script>
</body>
</html>
